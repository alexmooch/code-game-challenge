<!DOCTYPE html>
<html>
<head>
    <title>Headball Example</title>
    <meta charset="utf-8"/>
    <script>
        function ajax(path, method, data, headers) {
            return new Promise(function(resolve, reject) {
                var xhr = new XMLHttpRequest();
                xhr.open(method || 'GET', path || '/', true);

                if (headers && typeof headers === 'object') {
                    Object.keys(headers).forEach(function(name) {
                        xhr.setRequestHeader(name, headers[name]);
                    });
                }

                xhr.onreadystatechange = function() {
                    if (xhr.readyState != 4) return;
                    if (xhr.status === 0 || xhr.status === 200) {
                        resolve(xhr.responseText);
                    } else {
                        reject(new Error(xhr.status + ': ' + xhr.statusText + '(' + xhr.responseText + ')'));
                    }
                }

                xhr.send(data || null);
            });
        }
    </script>
</head>
<body>
    <div class="firstStrategy" style="float: left; width: 28%; height: 600px">
        <select id="first" style="width: 90%; margin-bottom: 10px"></select>
        <br>
        <textarea id="firstText" style="width: 90%; height: 90%; resize: none"></textarea>
    </div>
    <div class="secondStrategy" style="float: left; width: 28%; height: 600px">
        <select id="second" style="width: 90%; margin-bottom: 10px"></select>
        <br>
        <textarea id="secondText" style="width: 90%; height: 90%; resize: none"></textarea>
    </div>
    <div class="canvas" style="float: left; width: 44%">
        <canvas id="headball" width="800" height="600" style="background: #AAA"></canvas>
    </div>
    <!-- <div style="clear: both"></div> -->
    <br>
    <button onclick="startGame()">Start game!</button>

    <script>
        function render(state, canvas) {
            var w = state.world;
            var ctx = canvas.getContext('2d');

            var GROUND = w.HEIGHT - w.PLAYER_RAIDUS;

            ctx.fillStyle = '#55AAFF';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            ctx.fillStyle = '#FFCC00';
            ctx.fillRect(0, w.HEIGHT - 2 * w.PLAYER_RAIDUS, w.WIDTH, w.HEIGHT);

            var ball = w.ball;
            ctx.fillStyle = '#F21';
            ctx.beginPath();
            ctx.arc(ball.position.x, GROUND - ball.position.y, ball.radius, 0, 2 * Math.PI);
            ctx.fill();

            w.players.forEach(function(player, id) {
                ctx.fillStyle = state.offline.indexOf(id) === -1 ? 'green' : 'gray';
                ctx.beginPath();
                ctx.arc(player.position.x, GROUND - player.position.y, player.radius, 0, 2 * Math.PI);
                ctx.fill();

                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                // ctx.strokeStyle = 'black';
                ctx.fillStyle = 'white';
                ctx.font = 'bold 42px sans-serif';

                ctx.fillText('' + w.score[id], id * w.WIDTH / 2 +  w.WIDTH / 4, 20);
                ctx.fillText('' + player.name, id * w.WIDTH / 2 +  w.WIDTH / 4, 70);

                ctx.font = '12px';
                ctx.fillText('' + player.touchesLeft, player.position.x, GROUND - player.position.y);
            });

            ctx.textBaseline = 'bottom';
            ctx.textAlign = 'right';
            ctx.font = '18px sans-serif';
            ctx.fillStyle = 'white';
            ctx.fillText('Tick: ' + w.currentTick, w.WIDTH - 10, w.HEIGHT - 5);
        }

        var _id = null;
        function gameLoop(record) {
            var i = 0, cd = 0;
            var canvas = document.getElementById('headball');

            if (_id) cancelAnimationFrame(_id);

            (function _render() {
                if (i >= record.states.length) return;

                _id = requestAnimationFrame(_render);
                if (cd === 0){
                    render(record.states[i++], canvas);

                    var score = record.states[i].world.score;
                    record.states[i - 1].world.score.forEach(function(p, i) {
                        if (p !== score[i]) {
                            cd = 50;
                        }
                    });
                } else {
                    --cd;
                }
            })();
        }

        function startGame() {
            ajax('/game', 'POST', JSON.stringify({
                first:  document.getElementById('firstText').value,
                second: document.getElementById('secondText').value,
            }), {
                'Content-Type': 'application/json'
            }).then(function(record) {
                gameLoop(JSON.parse(record));
            }).catch(function(err) {
                console.log('Failure', err);
            });
        }

        var strategies = {};
        var first = document.getElementById('first');
        var second = document.getElementById('second');

        function updateText(select) {
            document.getElementById(select.id + 'Text').value = strategies[select.value];
        }

        first.addEventListener('change', function() {
            updateText(first);
        }, false);

        second.addEventListener('change', function() {
            updateText(second);
        }, false);

        ['Empty', 'Jump', 'Basic'].forEach(function(name, id) {
            ajax('/strategy/' + name.toLowerCase()).then(function(strategy) {
                strategies[name] = strategy;

                var option_f = document.createElement('option');
                var option_s = document.createElement('option');

                option_f.text = name;
                option_s.text = name;

                first.options.add(option_f, id);
                second.options.add(option_s, id);

                updateText(first);
                updateText(second);
            });
        });
    </script>
</body>
</html>
